!function(){var e,t,r,n,i,o,s,a,c,l,u,d;o=require("express"),s=require("fs"),a=require("http"),n=require("./custom_modules/database"),t=require("./custom_modules/calculator"),d=require("./custom_modules/user_id_generator"),u=require("socket.io"),r=require("./custom_modules/config"),process.env.VCAP_SERVICES?(i=JSON.parse(process.env.VCAP_SERVICES),r=i["mysql-5.1"][0].credentials,n.connect(r.hostname,r.username,r.password,r.db)):n.connect(r.data.host,r.data.username,r.data.password,r.data.database),e=o(),e.use(require("connect").bodyParser()),l=a.createServer(e),c=u.listen(l),l.listen(process.env.VCAP_APP_PORT||3e3),e.get("/",function(e,t){return s.readFile("./views/index.html",function(e,r){return t.writeHead(200,{"Access-Control-Allow-Origin":"*"}),t.write(r),console.log(r),t.end()})}),c.sockets.on("connection",function(e){return e.on("clientUserId",function(t,r){return e.set("user_id",t,function(){console.log(t)})}),e.on("displayToggle",function(t){var r,i;i=t.is_displayed,r=t.appliance_id,e.get("user_id",function(t,o){return n.updateDisplay(o,r,i),e.emit("displayToggle",r,i)})}),e.on("generateUserId",function(){var t;return t=d.generate(),t="2a550081-364e-4aa5-b438-4b21f60c158e",e.set("user_id",t,function(){return console.log(t),e.emit("receiveUserId",t)})})}),e.get("/appliances/fetch",function(e,t){return n.getAppliances(function(e){return t.writeHead(200,{"Access-Control-Allow-Origin":"*"}),t.write(JSON.stringify(e)),t.end()})}),e.get("/appliance_usage/fetch",function(e,t){return n.getApplianceUsage(e.query.user_id,function(e){return t.writeHead(200,{"Access-Control-Allow-Origin":"*"}),t.write(JSON.stringify(e)),t.end()})}),e.get("/views/fetch",function(e,t){var r,n;switch(n=e.query.view){case"realtime":r="realtime_view.html";break;case"timeline":r="timeline_view.html";break;case"models":r="model_views.html"}return s.readFile("./views/"+r,function(e,r){return t.writeHead(200,{"Access-Control-Allow-Origin":"*"}),t.write(r),t.end()})}),e.get("/timers/fetch",function(e,r){return n.getTimers(e.query.user_id,function(e){var n;return r.writeHead(200,{"Access-Control-Allow-Origin":"*"}),n=t.calculateTerminatedUsage(e),r.write(JSON.stringify(n)),r.end()})}),e.all("/timer/update/display",function(e,t){var r,i,o;return t.writeHead(200,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"PUT","Access-Control-Allow-Headers":"Content-Type"}),void 0!==e.body.appliance_id?(i=e.body.is_displayed,r=e.body.appliance_id,o=e.body.user_id,n.updateDisplay(o,r,i,function(){}),t.end()):t.end()}),e.post("/timer/storeTimestamp",function(e,t){var r,i,o,s,a;return t.writeHead(200,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST","Access-Control-Allow-Headers":"Content-Type"}),s=e.body.timestamp,r=e.body.appliance_id,o=e.body.is_active,o=(parseInt(o)+1)%2,a=e.body.user_id,n.appendTimeStamp(a,r,o,s),i={is_active:o},t.write(JSON.stringify(i)),t.end()}),e.get("/comparisons/generate",function(e,r){var i,o;return r.writeHead(200,{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST","Access-Control-Allow-Headers":"Content-Type"}),o=e.query.user_id,i=e.query.timestamp,console.log("query!! "+e.query.user_id),n.getTimers(o,function(e){return n.getRewards(function(s){return n.getAppliances(function(a){return n.getUserData(o,function(o){return n.getTariffData(o[0].region_id,function(n){var c,l,u;return u=t.calculateTerminatedUsage(e),l={timer_data:u,end_point:i,tariff_data:n,user_data:o[0],reward_data:s,appliance_data:a},console.log(l),c=t.calculateComparisons(l),r.write(JSON.stringify(c)),r.end()})})})})})})}.call(this);